<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TikTok & Instagram Automation (Neon + HeyGen)</title>
  <style>
    :root{--bg:#0b0c10;--card:#111318;--muted:#9aa4b2;--border:#1f2430;--brand:#00D09C;--ok:#22c55e;--danger:#ef4444}
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:#e5e7eb}
    .wrap{max-width:1024px;margin:24px auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px}
    h1{font-size:22px;margin:0 0 12px} h2{font-size:18px;margin:8px 0}
    label{display:block;font-size:12px;color:var(--muted);margin-top:10px}
    input,select,textarea{width:100%;padding:10px;margin-top:6px;background:#0f1116;border:1px solid #2a3140;border-radius:10px;color:#e5e7eb}
    button{background:var(--brand);color:#0b0c10;border:0;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    button:disabled{opacity:.5;cursor:not-allowed}
    .row{display:grid;grid-template-columns:1fr 1fr; gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr; gap:12px}
    .row4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr; gap:12px}
    .hint{font-size:12px;color:#9aa4b2}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    tr.clickable{cursor:pointer}
    tr.clickable:hover{background:#0f141a}
    .badge{display:inline-block;background:#151a22;border:1px solid #273042;padding:3px 8px;border-radius:999px;margin-right:6px;font-size:11px}
    .status-ok{color:var(--ok);font-weight:700}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;align-items:center}
    .toolbar input[type=file]{display:none}
    .topbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .link{background:#263042;color:#e5e7eb;border:1px solid #273042}
    .danger{background:transparent;border:1px solid var(--danger);color:#fecaca}
    .hidden{display:none}
    @media (max-width:740px){ .row3{grid-template-columns:1fr} .row{grid-template-columns:1fr} .row4{grid-template-columns:1fr 1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card topbar">
      <div>
        <h1 style="margin:0">TikTok & Instagram Automation (Neon + HeyGen)</h1>
        <div class="hint">Daten zentral in Neon Postgres. Brand: <span class="badge">#00D09C</span></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnGoComposer">Composer</button>
        <button id="btnGoSettings" class="link">Einstellungen</button>
      </div>
    </div>

    <!-- ===== MAIN VIEW (Composer + Library) ===== -->
    <div id="viewMain">
      <div class="card" id="composerCard">
        <!-- Composer-Inhalte wie gehabt -->
      </div>

      <div class="card">
        <h2>Bibliothek</h2>
        <div class="toolbar">
          <button id="reloadBtn">Neu laden</button>
          <label for="csvInput" class="link">CSV importieren</label>
          <input id="csvInput" type="file" accept=".csv" />
        </div>
        <table>
          <thead><tr><th>Datum</th><th>Plattform</th><th>Hook</th><th>Status</th><th>Datei</th><th>Aktion</th></tr></thead>
          <tbody id="videoRows"></tbody>
        </table>
      </div>
    </div>

    <!-- ===== SETTINGS VIEW ===== -->
    <div id="viewSettings" class="hidden">
      <!-- Einstellungen wie gehabt -->
      <div class="card"><button id="btnBack" class="link">← Zurück zum Composer</button></div>
    </div>
  </div>

  <script>
    // Hilfsfunktion API-Call
    async function api(op, table, payload) {
      const r = await fetch('/api/db', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({op, table, ...payload})});
      if(!r.ok) throw new Error(await r.text());
      return r.json();
    }
    function esc(s){return (s||'').replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));}

    async function loadVideos(){
      const res = await api('select','videos',{limit:50,order:{column:'created_at',desc:true}});
      const rows = res.rows||[];
      const out = rows.map(v=>{
        return `<tr>
          <td>${v.scheduled_at||''}</td>
          <td>${esc(v.platform)}</td>
          <td>${esc(v.hook||'')}</td>
          <td>${esc(v.status||'INIT')}${(v.status==='ERROR' && v.link)?' – '+esc(v.link):''}</td>
          <td>${v.file_url?`<a href=\"${v.file_url}\" target=\"_blank\">Download</a>`:'—'}</td>
          <td>
            <button onclick=\"startNow('${v.id}')\">Start jetzt</button>
            <button onclick=\"markPosted('${v.id}')\">Als gepostet</button>
            <button class=\"danger\" onclick=\"delVid('${v.id}')\">Löschen</button>
          </td>
        </tr>`;
      }).join('');
      document.getElementById('videoRows').innerHTML = out;
    }

    async function startNow(id){
      await api('update','videos',{values:{status:'QUEUED',scheduled_at:new Date().toISOString()}, where:{id}});
      loadVideos();
    }
    async function markPosted(id){
      await api('update','videos',{values:{status:'POSTED'},where:{id}});
      loadVideos();
    }
    async function delVid(id){
      await api('delete','videos',{where:{id}});
      loadVideos();
    }

    document.getElementById('reloadBtn').onclick=loadVideos;

    // CSV Upload
    document.getElementById('csvInput').addEventListener('change',async e=>{
      const file=e.target.files[0]; if(!file) return;
      const text=await file.text();
      const rows=text.split(/\\r?\\n/).filter(l=>l.trim()).map(l=>l.split(','));
      const headers=rows.shift().map(h=>h.trim());
      const vals=rows.map(r=>{let o={};headers.forEach((h,i)=>o[h]=r[i]);return o;});
      for(const v of vals){await api('insert','videos',{values:v});}
      loadVideos();
    });

    loadVideos();
  </script>
</body>
</html>
